# Session: 기능 추가/수정 (2026-02-08 14:16)

## Overview
- **Start Time:** 2026-02-08 14:16
- **End Time:** 2026-02-08 (multi-session, context compaction occurred)
- **Project:** Running Management App (vibe-test)
- **Git Branch:** main

## Goals
- 25.2.8 기능 추가 플랜 전체 구현 (대회 관리, 대시보드, 활동 분리)
- 25.2.8 요구 사항 수정 #1 반영 (대시보드 개선, 대회 등록/상세/결과 분리)
- 25.2.8 요구 사항 수정 #2 반영 (TCX 드래그앤드롭, 기존 활동 선택, ActivityDetailView 공통 컴포넌트)
- `my-requirement.md` → `requirement.md` 병합

---

## Git Summary

### Commits
- 0 commits made (모든 변경사항 uncommitted 상태)

### Files Changed (총 39 files from HEAD)

**Backend 수정 (4)**
| 파일 | 변경 |
|------|------|
| `backend/models.py` | Modified — Race, RaceImage, DistanceType, RaceStatus 모델 추가 |
| `backend/schemas.py` | Modified — Race CRUD + Dashboard 스키마 추가 |
| `backend/main.py` | Modified — races/dashboard 라우터 마운트, actual_time 마이그레이션 |
| `backend/requirements.txt` | Modified — aiofiles 추가 |

**Backend 신규 (2)**
| 파일 | 변경 |
|------|------|
| `backend/routers/races.py` | Added — Race CRUD, 이미지 업로드/삭제/서빙, TCX 업로드(활동 자동연결), 결과 업데이트 |
| `backend/routers/dashboard.py` | Added — 대시보드 API (다가오는 대회 2개, 이번달 전체 일자 러닝, 최근 활동 5개) |

**Frontend 수정 (6)**
| 파일 | 변경 |
|------|------|
| `frontend-ts/lib/types.ts` | Modified — Race, RaceImage, RaceFormData, RaceResultFormData, DashboardData 등 타입 추가 |
| `frontend-ts/lib/utils/format.ts` | Modified — formatTargetTime, distanceTypeLabel, daysUntil 등 유틸 추가 |
| `frontend-ts/components/layout/AppLayout.tsx` | Modified — 사이드바 3개 메뉴 (대시보드, 내 활동, 대회 관리) |
| `frontend-ts/app/dashboard/page.tsx` | Modified — 재작성: 다가오는 대회 카드, 이번달 러닝 차트, 최근 활동 리스트 |
| `frontend-ts/app/activity/[id]/page.tsx` | Modified — ActivityDetailView 공통 컴포넌트 사용으로 간소화 |
| `frontend-ts/next.config.ts` | Modified — images.remotePatterns 추가 (백엔드 이미지 URL) |

**Frontend 신규 (15)**
| 파일 | 변경 |
|------|------|
| `frontend-ts/app/activities/page.tsx` | Added — 내 활동 페이지 (기존 대시보드 콘텐츠 이동) |
| `frontend-ts/app/races/page.tsx` | Added — 대회 목록 + 상태 필터 |
| `frontend-ts/app/races/new/page.tsx` | Added — 대회 등록 (기본 정보만) |
| `frontend-ts/app/races/[id]/page.tsx` | Added — 대회 상세 (수정/결과 입력/삭제 버튼, 연결된 활동 전체 표시) |
| `frontend-ts/app/races/[id]/result/page.tsx` | Added — 결과 입력 별도 페이지 (상태, 완주시간, TCX D&D, 기존활동 선택, 사진, 후기) |
| `frontend-ts/lib/api/races.ts` | Added — Race API 클라이언트 |
| `frontend-ts/lib/api/dashboard.ts` | Added — Dashboard API 클라이언트 |
| `frontend-ts/components/dashboard/UpcomingRaceCard.tsx` | Added — 다가오는 대회 카드 (D-day, 거리, 목표시간) |
| `frontend-ts/components/dashboard/MonthlyRunningChart.tsx` | Added — 이번달 러닝 차트 (Recharts ComposedChart) |
| `frontend-ts/components/race/RaceCard.tsx` | Added — 대회 카드 컴포넌트 |
| `frontend-ts/components/race/RaceStatusChip.tsx` | Added — 상태별 색상 칩 |
| `frontend-ts/components/race/RaceForm.tsx` | Added — 대회 생성/수정 폼 (기본 정보만) |
| `frontend-ts/components/race/RaceImageUpload.tsx` | Added — 이미지 D&D 업로드 + 갤러리 |
| `frontend-ts/components/race/ActivitySelector.tsx` | Added — 기존 활동 선택 셀렉터 |
| `frontend-ts/components/activity/ActivityDetailView.tsx` | Added — 활동 상세 공통 컴포넌트 (Stats + LapTable + PaceHRChart) |

**인프라 (1)**
| 파일 | 변경 |
|------|------|
| `docker-compose.yml` | Modified — backend-uploads 볼륨 추가 |

**문서 (2)**
| 파일 | 변경 |
|------|------|
| `.my-docs/requirement.md` | Modified — my-requirement.md 병합 + 수정 #2 추가 |
| `.my-docs/my-requirement.md` | Deleted — requirement.md에 병합됨 |

**기존 frontend/ 삭제 (19 files)**
- 이전 세션에서 삭제된 상태 그대로 (frontend-ts로 대체)

**테스트 데이터 (1)**
| 파일 | 변경 |
|------|------|
| `test-data/February_Morning_Run.tcx` | Added — 테스트용 TCX (2026-02-05, 3km, 3랩) |

---

## Key Accomplishments

### Phase 1-3: Backend
- Race, RaceImage ORM 모델 + DistanceType/RaceStatus enum 추가
- Race CRUD 라우터 (생성, 목록, 상세, 수정, 삭제)
- 이미지 업로드/삭제/서빙 (max 5장, 5MB, UUID 기반)
- `PUT /races/{id}/result` — 결과 업데이트 (status, actual_time, activity_id, review)
- `POST /races/{id}/upload-tcx` — TCX 업로드 → 활동 자동 생성 or 기존 활동 연결
- Dashboard API — 다가오는 대회 2개, 이번달 전체 일자 러닝 집계, 최근 활동 5개
- SQLite 마이그레이션 (actual_time 컬럼 자동 추가)

### Phase 4-6: Frontend
- 사이드바 3개 메뉴 (대시보드, 내 활동, 대회 관리)
- 새 대시보드: 다가오는 대회 카드(클릭 → 상세), 이번달 러닝 차트(모든 날짜 표시), 최근 활동 리스트
- 내 활동 페이지 분리 (기존 대시보드 → /activities)
- 대회 목록 + 상태 필터 (ToggleButtonGroup)
- 대회 등록: 기본 정보만 (대회명, 일시, 장소, 거리, 목표시간)
- 대회 상세: 모든 정보 표시 + "수정" / "결과 입력" / "삭제" 버튼 분리
- 결과 입력 별도 페이지: 상태, 완주시간, TCX 드래그앤드롭, 기존 활동 선택(탭 전환), 사진 업로드, 후기

### 요구 사항 수정 #2
- TCX 업로드를 Activity 페이지와 동일한 드래그앤드롭 UI로 구현
- "TCX 파일 업로드" / "기존 활동 선택" 탭 전환 UI
- ActivityDetailView 공통 컴포넌트 생성 → activity/[id] 페이지와 races/[id] 페이지에서 재사용
- 대회 상세에서 연결된 활동의 모든 정보 표시 (요약, 랩 분석, 페이스&심박수 차트)

### 문서 정리
- `my-requirement.md` → `requirement.md`에 병합 후 삭제

---

## Problems Encountered & Solutions

| 문제 | 해결 |
|------|------|
| MonthlyRunningChart Tooltip formatter TypeScript 타입 에러 | `(value, name)` 에서 explicit type 제거 |
| ActivitySelector 비교 타입 에러 (`number` vs `string`) | `e.target.value as string \| number` 캐스팅 |
| SQLite에 actual_time 컬럼 추가 필요 | `main.py`에서 `inspect()` + `ALTER TABLE` 마이그레이션 |
| Race 상세에서 연결된 활동 정보가 요약만 표시 | ActivityDetailView 공통 컴포넌트로 전체 정보(Stats+Lap+Chart) 표시 |

## Dependencies Added
- **Backend:** `aiofiles` (비동기 파일 처리)
- **Frontend:** 없음 (기존 MUI, Recharts 활용)

## Configuration Changes
- `docker-compose.yml` — `backend-uploads` named volume 추가
- `frontend-ts/next.config.ts` — `images.remotePatterns` (백엔드 이미지 URL 허용)

## What Wasn't Completed
- Git commit 미수행 (모든 변경사항 uncommitted)
- Docker 통합 테스트 미수행
- 브라우저 E2E 테스트 미수행 (TypeScript + Next.js 빌드는 통과)

## Tips for Future Development
- `RaceResultFormData`에 `activity_id` 필드가 있으므로, 결과 저장 시 활동 연결/해제가 한번에 처리됨
- TCX 업로드(`POST /races/{id}/upload-tcx`)는 즉시 서버에서 activity_id를 설정하므로, 결과 저장과 별개로 동작
- `ActivityDetailView`는 `activityId`만 받으면 자체적으로 fetch → 어디서든 재사용 가능
- SQLite 마이그레이션은 `main.py` startup에서 `inspect()` 기반으로 동작 — 새 컬럼 추가 시 동일 패턴 사용
- 이미지 파일은 `uploads/races/{race_id}/{uuid}.{ext}`에 저장됨
